---
import SummaContent from '../../../layouts/SummaContent.astro';
import LegacyContent from '../../../layouts/LegacyContent.astro';
import fs from 'node:fs';
import path from 'node:path';

export const prerender = true;

// Summa parts for validation
const PARTS = ['FP', 'FS', 'SS', 'TP', 'XP', 'X1', 'X2'];

// Generate static paths for all Summa files
export async function getStaticPaths() {
  const summaDir = path.join(process.cwd(), 'public/thomas/summa');
  const pathSet = new Set<string>();

  function walkDir(dir: string, basePath: string = '') {
    if (!fs.existsSync(dir)) return;

    const entries = fs.readdirSync(dir, { withFileTypes: true });

    for (const entry of entries) {
      const fullPath = path.join(dir, entry.name);
      const relativePath = basePath ? `${basePath}/${entry.name}` : entry.name;

      if (entry.isDirectory()) {
        walkDir(fullPath, relativePath);
      } else if (entry.name.endsWith('.html') || entry.name.endsWith('.htm')) {
        if (entry.name === 'index.html' || entry.name === 'index.htm') {
          if (basePath) {
            pathSet.add(basePath);
          }
        } else {
          const pathWithoutExt = relativePath.replace(/\.(html|htm)$/, '');
          pathSet.add(pathWithoutExt);
        }
      }
    }
  }

  walkDir(summaDir);

  const paths = Array.from(pathSet).map(p => ({ params: { path: p } }));
  paths.push({ params: { path: undefined } }); // /thomas/summa/

  return paths;
}

const { path: urlPath } = Astro.params;

// Resolve the file path
let filePath: string;
let htmlContent: string = '';
let title = 'Summa Theologica';
let currentPart = '';
let currentQuestion: number | undefined;

// Check if path exists and is a file
const isFile = (p: string) => {
  try {
    return fs.existsSync(p) && fs.statSync(p).isFile();
  } catch {
    return false;
  }
};

if (!urlPath) {
  filePath = path.join(process.cwd(), 'public/thomas/summa/index.html');
} else {
  const basePath = path.join(process.cwd(), 'public/thomas/summa', urlPath);

  if (isFile(basePath + '.html')) {
    filePath = basePath + '.html';
  } else if (isFile(basePath + '.htm')) {
    filePath = basePath + '.htm';
  } else if (isFile(path.join(basePath, 'index.html'))) {
    filePath = path.join(basePath, 'index.html');
  } else if (isFile(basePath)) {
    filePath = basePath;
  } else {
    filePath = basePath + '.html';
  }

  // Parse part and question from path
  // Paths like: "FP" (part TOC), "FP/FP001" (question)
  const pathParts = urlPath.split('/');
  if (pathParts.length >= 1) {
    const partCandidate = pathParts[0];
    if (PARTS.includes(partCandidate)) {
      currentPart = partCandidate;
    }
  }

  if (pathParts.length >= 2) {
    // Extract question number from filename like "FP001"
    const filename = pathParts[pathParts.length - 1];
    const match = filename.match(/^[A-Z]{2}(\d{3})$/);
    if (match) {
      currentQuestion = parseInt(match[1], 10);
    }
  }
}

// Read and process the HTML file
if (fs.existsSync(filePath)) {
  const rawHtml = fs.readFileSync(filePath, 'utf-8');

  // Extract title from <title> tag
  const titleMatch = rawHtml.match(/<title[^>]*>([^<]+)<\/title>/i);
  if (titleMatch) {
    title = titleMatch[1].trim();
  }

  // Extract body content
  const bodyMatch = rawHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
  if (bodyMatch) {
    htmlContent = bodyMatch[1];
  } else {
    htmlContent = rawHtml;
  }

  // Clean up old styles and fix links
  htmlContent = htmlContent
    .replace(/\s*bgcolor="[^"]*"/gi, '')
    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
    // Fix relative links and strip .htm/.html extensions
    .replace(/href="\.\.\/([^"]+)"/gi, (match, p1) => {
      const cleanPath = p1.replace(/\.(html?)(#.*)?$/i, '$2');
      return `href="/thomas/summa/${cleanPath}"`;
    })
    .replace(/href="([^/"#][^"#]*)"/gi, (match, p1) => {
      if (!p1.startsWith('http') && !p1.startsWith('/') && !p1.startsWith('#')) {
        const currentDir = urlPath ? path.dirname(urlPath) : '';
        // Strip .htm/.html extension, preserve hash fragment
        const cleanFile = p1.replace(/\.(html?)(#.*)?$/i, '$2');
        if (currentDir && currentDir !== '.') {
          return `href="/thomas/summa/${currentDir}/${cleanFile}"`;
        }
        return `href="/thomas/summa/${cleanFile}"`;
      }
      return match;
    });
} else {
  htmlContent = '<p>Content not found.</p>';
}

// Use SummaContent layout for questions, LegacyContent for index pages
const useSummaNav = currentPart && (currentQuestion || PARTS.includes(urlPath || ''));
---

{useSummaNav ? (
  <SummaContent title={title} currentPart={currentPart} currentQuestion={currentQuestion}>
    <Fragment set:html={htmlContent} />
  </SummaContent>
) : (
  <LegacyContent title={title}>
    <Fragment set:html={htmlContent} />
  </LegacyContent>
)}
